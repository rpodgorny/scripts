#!/usr/bin/python3

import sys
import subprocess


def run(cmd):
	print('+ %s' % cmd)
	return subprocess.call(cmd, shell=True)


def partition_format_mount(dev, name, mountpoint, swap_size_gb=1):
	part_boot = '%s%s1' % (dev, 'p' if 'nvme' in dev or 'mmcblk' in dev else '')
	part_swap = '%s%s2' % (dev, 'p' if 'nvme' in dev or 'mmcblk' in dev else '')
	part_root = '%s%s3' % (dev, 'p' if 'nvme' in dev or 'mmcblk' in dev else '')
	#assert run('test -b %s' % dev) == 0
	#for part in [part_boot, part_swap, part_root]:
	#	assert run('test ! -b %s' % part) != 0

	run('dd if=/dev/zero of=%s bs=10M count=1' % dev)

	run('partprobe')

	run('parted --script -a optimal %s -- mklabel gpt mkpart primary fat32 0%% 1GB mkpart primary linux-swap 1GB %dGB mkpart primary btrfs %dGB 100%% set 1 boot on' % (dev, (1 + swap_size_gb), (1 + swap_size_gb)))
	#run('parted --script -a optimal %s -- mklabel gpt mkpart primary fat32 0%% 1GB mkpart primary linux-swap 1GB %dGB mkpart primary xfs %dGB 100%% set 1 boot on' % (dev, (1 + swap_size_gb), (1 + swap_size_gb)))

	run('mkfs.vfat -n %s_BOOT %s' % (name.upper(), part_boot))
	run('mkswap -L SWAP %s' % part_swap)
	run('mkfs.btrfs -f -L %s_ROOT %s' % (name.upper(), part_root))
	#run('mkfs.xfs -f -L %s_ROOT %s' % (name.upper(), part_root))

	run(f'mount -o relatime,compress=zstd {part_root} {mountpoint}')
	#run(f'mount {part_root} {mountpoint}')
	run(f'mkdir {mountpoint}/boot')
	run(f'mount {part_boot} {mountpoint}/boot')


def bootstrap(name, mountpoint):
	run(f'pacstrap {mountpoint} base linux linux-firmware openssh intel-ucode btrfs-progs')
	#run(f'pacstrap {mountpoint} base linux linux-firmware openssh intel-ucode xfsprogs')

	#run(f'arch-chroot {mountpoint} pacman-key --populate')  # is this really needed?

	run(f'arch-chroot {mountpoint} bootctl install')

	run(f'arch-chroot {mountpoint} mkdir -p /boot/loader/entries')
	s = '''title   Arch Linux
linux   /vmlinuz-linux
initrd  /intel-ucode.img
initrd  /initramfs-linux.img
options root=/dev/disk/by-label/%s_ROOT rw''' % name.upper()
	with open(f'{mountpoint}/boot/loader/entries/arch.conf', 'w') as f:
		f.write(s)

	with open(f'{mountpoint}/etc/hostname', 'w') as f:
		f.write(name)

	s = '''[Match]
Name=en*

[Network]
DHCP=yes'''
	with open(f'{mountpoint}/etc/systemd/network/en.network', 'w') as f:
		f.write(s)

	run(f'arch-chroot {mountpoint} timedatectl set-timezone Europe/Prague')

	run(f'arch-chroot {mountpoint} systemctl enable systemd-networkd')
	run(f'arch-chroot {mountpoint} systemctl enable systemd-resolved')
	run(f'arch-chroot {mountpoint} systemctl enable systemd-timesyncd')
	run(f'arch-chroot {mountpoint} systemctl enable sshd')

	run(f'cp ~/scripts/fix_system {mountpoint}/')
	#run(f'arch-chroot {mountpoint} pacman -Syu --noconfirm python')
	run(f'pacstrap {mountpoint} python')
	run(f'arch-chroot {mountpoint} /fix_system -y')
	run(f'rm {mountpoint}/fix_system')

	run(f'arch-chroot {mountpoint} pacman -Scc --noconfirm')


def umount(mountpoint):
	run(f'umount -R {mountpoint}')


def main():
	dev = sys.argv[1]
	assert dev
	name = sys.argv[2]
	assert name

	mountpoint = '/mnt'

	partition_format_mount(dev, name, mountpoint)
	bootstrap(name, mountpoint)
	umount(mountpoint)

	return 0


if __name__ == '__main__':
	sys.exit(main())
