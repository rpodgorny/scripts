#!/bin/bash

ws_json=$(niri msg --json workspaces)
name=$(echo "$ws_json" | jq -r '[.[] | select(.name != "" and .name != null and .is_focused != true)] | sort_by(.name) | .[].name' | wofi --dmenu -e -p 'move to workspace')
[ -z "$name" ] && exit 0
current_idx=$(echo "$ws_json" | jq '[.[] | select(.is_focused)] | .[0].idx')
current_ws_id=$(echo "$ws_json" | jq '[.[] | select(.is_focused)] | .[0].id')

if echo "$ws_json" | jq -e --arg n "$name" '.[] | select(.name == $n)' > /dev/null 2>&1; then
    # Workspace exists — move window there
    niri msg action move-window-to-workspace "$name"
else
    # Workspace doesn't exist — create one below current
    output=$(echo "$ws_json" | jq -r '[.[] | select(.is_focused)] | .[0].output')
    ws_count=$(echo "$ws_json" | jq --arg o "$output" '[.[] | select(.output == $o)] | length')

    # Move window to the empty workspace at the bottom (focus follows)
    niri msg action move-window-to-workspace "$ws_count"

    # Name this workspace
    niri msg action set-workspace-name "$name"

    # Move it up to be right below the original workspace
    moves=$((ws_count - current_idx - 1))
    for ((i = 0; i < moves; i++)); do
        niri msg action move-workspace-up
    done
fi

# If original workspace is now empty, stay with the window;
# otherwise return focus to original workspace
remaining=$(niri msg --json windows | jq --argjson wsid "$current_ws_id" '[.[] | select(.workspace_id == $wsid)] | length')
if [ "$remaining" -gt 0 ]; then
    niri msg action focus-workspace "$current_idx"
fi
