#!/bin/bash

repo="rpodgorny"

# get all packages installed from your repo
pkgs=$(pacman -Sl $repo | awk '/\[installed\]/{print $2}')

outdated_packages=()

for pkg in $pkgs; do
    local_ver=$(pacman -Q $pkg | awk '{print $2}')
    aur_ver=$(curl -s "https://aur.archlinux.org/rpc/?v=5&type=info&arg[]=$pkg" \
        | jq -r '.results[0].Version')

    if [ "$aur_ver" != "null" ] && [ "$(vercmp "$aur_ver" "$local_ver")" -gt 0 ]; then
        echo "$pkg $local_ver -> $aur_ver"
        outdated_packages+=("$pkg")
    fi
done

if [ ${#outdated_packages[@]} -eq 0 ]; then
    echo "No outdated packages found."
    exit 0
fi

test -x /usr/bin/gum

options=""
for pkg in ${outdated_packages[@]}; do
    options="${options}${pkg}\n"
done

selected_packages=$(echo -e "${options}" | gum choose --no-limit --header "Select packages to rebuild")

if [ -z "$selected_packages" ]; then
    echo "No packages selected."
    exit 0
fi

echo
echo "Selected packages for rebuilding:"
echo "$selected_packages"
echo

cd /var/tmp/tmp || { echo "Cannot cd to /var/tmp/tmp"; exit 1; }

for pkg in $selected_packages; do
    echo "Rebuilding $pkg..."

    rm -rf $pkg
    
    # Get PKGBUILD
    echo "Getting PKGBUILD for $pkg..."
    yay -aG "$pkg" || { echo "Failed to get PKGBUILD for $pkg"; continue; }
    
    # Build package
    cd "$pkg" || { echo "Cannot cd to $pkg directory"; continue; }
    echo "Building package..."
    makepkg-rpodgorny -s --skippgpcheck || { echo "Failed to build $pkg"; continue; }
    
    echo "Successfully built $pkg"
    echo

    rm -rf $pkg
    
    # Go back to tmp directory for next package
    cd /var/tmp/tmp
done

echo "Done."
