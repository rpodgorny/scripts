#!/usr/bin/python3

'''
Run command on multiple hosts.

Usage:
  run_all [-g <group>] <command>

Options:
  -g <group>  Group of hosts.

Arguments:
  <command>  Command to run.
'''

import subprocess
import docopt

hosts = {}

hosts['default'] = set([
	'berta.podgorny.cz',
	'chuck.podgorny.cz',
	'europa.podgorny.cz',
	'hubert.asterix.cz',
	'krabicka.podgorny.cz',
	'kulicka.podgorny.cz',
	'milhouse.podgorny.cz',
	'mrtvola.asterix.cz',
	'orion.asterix.cz',
	'pimiento.podgorny.cz',
	'simir.podgorny.cz',
	'taurus.asterix.cz',
])

hosts['miners'] = set('miner%d.asterix.cz' % i for i in range(1, 13))

def main():
	args = docopt.docopt(__doc__)

	group = args['-g']

	if not group:
		selected_hosts = hosts['default']
	elif group == 'all':
		selected_hosts = hosts['default'] | hosts['miners']
	else:
		selected_hosts = hosts[group]
	#endif

	for host in selected_hosts:
		cmd = 'ssh -o ConnectTimeout=2 -t %s %s' % (host, args['<command>'])
		print('>> %s' % cmd)
		subprocess.call(cmd, shell=True)
	#endfor
#enddef


if __name__ == '__main__':
	main()
#enddef
