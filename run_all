#!/usr/bin/python3

'''
Run command on multiple hosts.

Usage:
  run_all [-g <group>] <command>
  run_all [-g <group>] --copy-keys

Options:
  -g <group>   Group of hosts.
  --copy-keys  Copy local ssh keys to remote servers.

Arguments:
  <command>  Command to run.
'''

import subprocess
import docopt

hosts = {}

hosts['arm'] = set([
	'berta.podgorny.cz',
	'europa.podgorny.cz',
	'kulicka.podgorny.cz',
	'pokuston.podgorny.cz',
	'ucho.podgorny.cz',
])

hosts['asterix'] = set([
	'hubert.asterix.cz',
	'mrtvola.asterix.cz',
	'orion.asterix.cz',
	'taurus.asterix.cz',
])

hosts['podgorny'] = set([
	'berta.podgorny.cz',
	'chuck.podgorny.cz',
	'europa.podgorny.cz',
	'krabicka.podgorny.cz',
	'kulicka.podgorny.cz',
	'milhouse.podgorny.cz',
	'pimiento.podgorny.cz',
	'pokuston.podgorny.cz',
	'simir.podgorny.cz',
	'ucho.podgorny.cz',
])

hosts['miners'] = set('miner%d.asterix.cz' % i for i in range(1, 13))


class color:
	PURPLE = '\033[95m'
	CYAN = '\033[96m'
	DARKCYAN = '\033[36m'
	BLUE = '\033[94m'
	GREEN = '\033[92m'
	YELLOW = '\033[93m'
	RED = '\033[91m'
	BOLD = '\033[1m'
	UNDERLINE = '\033[4m'
	END = '\033[0m'
#endclass


def main():
	args = docopt.docopt(__doc__)

	group = args['-g']

	if group:
		selected_hosts = hosts[group]
	else:
		# all
		selected_hosts = set()
		for k, v in hosts.items():
			selected_hosts |= v
		#endfor
	#endif

	for host in sorted(list(selected_hosts)):
		if args['--copy-keys']:
			cmd = 'ssh-copy-id -i ~/.ssh/id_ecdsa.pub %s' % host
		else:
			cmd = 'ssh -o ConnectTimeout=2 -t %s %s' % (host, args['<command>'])
		#endif

		print('%s%s%s%s' % (color.BOLD, color.YELLOW, cmd, color.END))
		subprocess.call(cmd, shell=True)
	#endfor
#enddef


if __name__ == '__main__':
	main()
#enddef
