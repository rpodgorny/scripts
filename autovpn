#!/usr/bin/clj

(ns autovpn.core
  (:require [clojure.string :as str]
            [clojure.java.shell :as sh])
  (:gen-class))


(def IFACE "wlp2s0")
(def VPN "asterix")
(def SLEEP 10)

(defn openvpn-active? [vpn]
  (let [cmd (sh/sh "systemctl" "is-active" (format "openvpn-client@%s.service" vpn))]
    (= (:exit cmd) 0)))

(defn start-stop-openvpn [vpn action]
  (println action)
  (sh/sh "sudo" "systemctl" action (format "openvpn-client@%s.service" vpn)))

(defn cut-iface [line]
  (str/trim (second (str/split line #":"))))

(defn cut-addr [line]
  (second (str/split (str/trim line) #" ")))

(defn is-line-with-addr [line cur-iface]
  (and cur-iface (str/includes? line "inet6")))

(defn is-line-with-iface [line]
  (str/includes? line "mtu"))

(defn get-ipv6-addrs []
  (let [cmd (sh/sh "ip" "addr")
        lines (str/split (:out cmd) #"\n")]
    (defn parse [lines cur-iface res]
      (if (empty? lines)
        res
        (if (is-line-with-iface (first lines))
          (let [iface (cut-iface (first lines))
                res (assoc res iface #{})]
            (parse (rest lines) iface res))
          (let [res (if (is-line-with-addr (first lines) cur-iface)
                      (update-in res [cur-iface] conj (cut-addr (first lines)))
                      res)]
            (parse (rest lines) cur-iface res)))))
    (parse lines nil {})))

(defn public-addr? [addr]
  (let [host (first (str/split addr #"/"))]
    (not (.isLinkLocalAddress (java.net.Inet6Address/getByName host)))))

(defn public-addr-old? [addr]
  (str/starts-with? addr "20"))

(defn tick [iface vpn]
  (let [addrs (get-ipv6-addrs)
        has-public-addr (some public-addr? (get addrs iface))
        openvpn-active (openvpn-active? vpn)]
    ;;(println ["tick" addrs has-public-addr openvpn-active])
    (cond
      (and has-public-addr openvpn-active) (start-stop-openvpn vpn "stop")
      (and (not has-public-addr) (not openvpn-active)) (start-stop-openvpn vpn "start"))))

(defn sleep [s]
  (Thread/sleep (* s 1000)))

(defn -main [& args]
  (println "starting autovpn")
  (while 1
    (tick IFACE VPN)
    (sleep SLEEP))
  (println "exit"))

(-main)
